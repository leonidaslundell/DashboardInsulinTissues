---
title: "Diabetes and insulin resistance in three metabolic tissues"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: sandstone
    orientation: columns
    vertical_layout: fill

runtime: shiny
  
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(data.table)
```

```{r, include = F}
load("data/results.Rdata")

rank2logFC <- function(x, title = ""){
  ggplot(x, mapping = aes(x = rank, y = logFC, col = adj.P.Val)) +
    geom_point() +
    geom_hline(yintercept = 0, color = "gray") +
    scale_color_gradient(trans = "log", low = "red", high = "black", 
                         breaks = c(0, 0.001, 0.05, 0.5)) +
    scale_shape(name = "Tissue") +
    xlab("Rank (high expression -> low expression") + 
    ylab("logFC (IR/T2D vs NGT)") +
    ggtitle(title) +
    theme_bw()
}

tissueComp <- function(gene){
  ggplot(dat[gene,], aes(x = rank, y = logFC, shape = L1, col = adj.P.Val)) +
    geom_point(size = 5) +
    geom_hline(yintercept = 0, color = "black", lty = "dotted", size = 2) +
    geom_blank(data = data.frame(adj.P.Val = c(min(dat$adj.P.Val), 0.05, 1)), 
               aes(col = adj.P.Val), inherit.aes = F) +
    scale_color_gradient2(low = "red", mid = "darkred", high = "black", midpoint = 0.05,
                          breaks = c(0, 0.001, 0.05, 0.1), 
                          limits = c(min(dat$adj.P.Val), 0.1)#midpoint = 0.05
    ) +
    scale_shape_manual(name = "Tissue",  values = c(adipose = "circle",
                                                    beta = "triangle",
                                                    skeletal = "square")) +
    theme_bw() +
    ylab("logFC (IR/T2D vs NGT)") +
    facet_wrap(~value) 
}

```

Column {.sidebar}
--------------------------------------------------

```{r}
textInput("gene", value = "SLC2A4", label = "Type gene of interest")
```


Column {data-width=400}
--------------------------------------------------


```{r}
output$adiposePlot <- renderPlot(rank2logFC(dat[L1 == "adipose"&abs(logFC)>.32,], "Adipose tissue"))
output$betaPlot <- renderPlot(rank2logFC(dat[L1 == "beta"&abs(logFC)>.32,], "Beta cell"))
output$skeletalPlot <- renderPlot(rank2logFC(dat[L1 == "skeletal"&abs(logFC)>.32,], "Skeletal muscle"))
```

### Adipose tissue

```{r}
plotOutput("adiposePlot", brush = "adiposeBrush")
```

### Beta cell

```{r}
plotOutput("betaPlot", brush = "betaBrush")
```

### Skeletal muscle

```{r}
plotOutput("skeletalPlot", brush = "skeletalBrush")
```

Column {data-width=600}
--------------------------------------------------

```{r}

gene <- reactiveValues(gene = "SLC2A4")

observeEvent(input$gene, {
  gene$gene <- input$gene
})

observeEvent(c(input$skeletalBrush,
               input$betaBrush,
               input$adiposeBrush),{
                 temp <- c(
                   brushedPoints(dat[L1 == "adipose" & abs(logFC)>.32,], 
                                 input$adiposeBrush, "rank", "logFC")$value,
                   brushedPoints(dat[L1 == "beta" & abs(logFC)>.32,], 
                                 input$betaBrush, "rank", "logFC")$value,
                   brushedPoints(dat[L1 == "skeletal" & abs(logFC)>.32,], 
                                 input$skeletalBrush, "rank", "logFC")$value)
                 gene$gene <- temp
               })

observeEvent(gene$gene, {
  print(gene$gene)
  if(length(gene$gene)>5){
    # gene$gene <- NULL
    temp <- ggplot(data.frame(x = 1, y = 1, label = "Too many genes to visualize"), 
                   aes(x,y,label = label)) + geom_text() + theme_void()
    output$genes <- renderPlot(temp)
    # showNotification("Too many genes to visualize")
  }else{
    if(length(gene$gene)==0){
      temp <- ggplot(data.frame(x = 1, y = 1, label = "Select interesting genes from from the plots"), 
                   aes(x,y,label = label)) + geom_text() + theme_void()
      output$genes <- renderPlot(temp)
    }else{
      output$genes <- renderPlot(tissueComp(as.character(gene$gene)))
    }
  }
})
```

### Gene

```{r}
plotOutput("genes")
```

### Table
```{r}
renderDataTable(dat[value %in% gene$gene, c("value", "L1", "logFC", "adj.P.Val", "rank")][order(L1)],
                options = list(paginate = FALSE))
```

