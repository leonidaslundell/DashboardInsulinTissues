---
title: "Diabetes and insulin resistance in three metabolic tissues"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: sandstone
    orientation: columns
    vertical_layout: fill

runtime: shiny
  
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(data.table)
# tags$head(includeHTML(("analytics.html")))
```

```{r, include = F}
library(GAlogger)
ga_set_tracking_id(as.character(read.table("BigBrotherCookie.txt", header = F)))
ga_set_approval(consent = TRUE)

ga_collect_pageview(page = "/main")

load("data/results.Rdata")

rank2logFC <- function(x, title = "", 
                       xZoom = c(NA, NA),
                       yZoom = c(NA, NA)){
  
  ggplot(x, mapping = aes(x = Rank, y = logFC, col = adj.P.Val)) +
    geom_point() +
    geom_hline(yintercept = 0, color = "gray") +
    scale_color_gradient(trans = "log", low = "red", high = "black", 
                         breaks = c(0, 0.001, 0.05, 0.5)) +
    scale_shape(name = "Tissue") +
    xlab("Rank (high expression -> low expression)") + 
    ylab("logFC (IR/T2D vs NGT)") +
    coord_cartesian(xlim = xZoom, ylim = yZoom) +
    theme_bw()
  
}

tissueComp <- function(gene){
  ggplot(dat[gene,], aes(x = Rank, y = logFC, shape = Tissue, col = adj.P.Val)) +
    geom_point(size = 5) +
    geom_hline(yintercept = 0, color = "black", lty = "dotted", size = 2) +
    geom_blank(data = data.frame(adj.P.Val = c(min(dat$adj.P.Val), 0.05, 1)), 
               aes(col = adj.P.Val), inherit.aes = F) +
    scale_color_gradient2(low = "red", mid = "darkred", high = "black", midpoint = 0.05,
                          breaks = c(0, 0.001, 0.05, 0.1), 
                          limits = c(min(dat$adj.P.Val), 0.1)#midpoint = 0.05
    ) +
    scale_shape_manual(name = "Tissue",  values = c(adipose = "circle",
                                                    beta = "triangle",
                                                    skeletal = "square")) +
    theme_bw() +
    ylab("logFC (IR/T2D vs NGT)") +
    facet_wrap(~Symbol) 
}

```

Column {.sidebar}
--------------------------------------------------

```{r}
textInput("gene", value = "SLC2A4", label = "Type gene of interest")
```


Column {data-width=400}
--------------------------------------------------

### Adipose tissue

```{r}
ranges <- reactiveValues(x = NULL, y = NULL)
```

**Click once for zooming in, double click for zooming out.**

```{r}
plotOutput("adiposePlot", brush = "adiposeBrush", click = "adiposeZoomIn", dblclick = "adiposeZoomOut")

output$adiposePlot <- renderPlot(
  rank2logFC(dat[Tissue == "adipose"&abs(logFC)>.32,], 
             "Adipose tissue")
)
output$adiposePlot <- renderPlot(
    rank2logFC(dat[Tissue == "adipose"&abs(logFC)>.32,], 
               xZoom = ranges$x,
               yZoom = ranges$y,
               "Adipose tissue")
  )

observeEvent(input$adiposeZoomIn, {
  ga_collect_event(event_category = "Plot manipulation", event_action = "Zooming in")
  if(!is.null(input$adiposeBrush)){
    ranges$x <- c(input$adiposeBrush$xmin, input$adiposeBrush$xmax)
    ranges$y <- c(input$adiposeBrush$ymin, input$adiposeBrush$ymax) 
  }
})
observeEvent(input$adiposeZoomOut, {
  ga_collect_event(event_category = "Plot manipulation", event_action = "Zooming out")
  ranges$x <- c(NA, NA)
  ranges$y <- c(NA, NA)
})
```

### Beta cell

```{r}
plotOutput("betaPlot", brush = "betaBrush", click = "betaZoomIn", dblclick = "betaZoomOut")

output$betaPlot <- renderPlot(
  rank2logFC(dat[Tissue == "beta"&abs(logFC)>.32,], 
             "beta tissue")
)
output$betaPlot <- renderPlot(
    rank2logFC(dat[Tissue == "beta"&abs(logFC)>.32,], 
               xZoom = ranges$x,
               yZoom = ranges$y,
               "beta tissue")
  )

observeEvent(input$betaZoomIn, {
  ga_collect_event(event_category = "Plot manipulation", event_action = "Zooming in")
  if(!is.null(input$betaBrush)){
    ranges$x <- c(input$betaBrush$xmin, input$betaBrush$xmax)
    ranges$y <- c(input$betaBrush$ymin, input$betaBrush$ymax) 
  }
})
observeEvent(input$betaZoomOut, {
  ga_collect_event(event_category = "Plot manipulation", event_action = "Zooming out")
  ranges$x <- c(NA, NA)
  ranges$y <- c(NA, NA)
})
```

### Skeletal muscle

```{r}
plotOutput("skeletalPlot", brush = "skeletalBrush", click = "skeletalZoomIn", dblclick = "skeletalZoomOut")

output$skeletalPlot <- renderPlot(
  rank2logFC(dat[Tissue == "skeletal"&abs(logFC)>.32,], 
             "skeletal tissue")
)
output$skeletalPlot <- renderPlot(
    rank2logFC(dat[Tissue == "skeletal"&abs(logFC)>.32,], 
               xZoom = ranges$x,
               yZoom = ranges$y,
               "skeletal tissue")
  )

observeEvent(input$skeletalZoomIn, {
  if(!is.null(input$skeletalBrush)){
    ranges$x <- c(input$skeletalBrush$xmin, input$skeletalBrush$xmax)
    ranges$y <- c(input$skeletalBrush$ymin, input$skeletalBrush$ymax) 
  }
})
observeEvent(input$skeletalZoomOut, {
  ga_collect_event(event_category = "Plot manipulation", event_action = "Zooming out")
  ranges$x <- c(NA, NA)
  ranges$y <- c(NA, NA)
})
```

Column {data-width=600}
--------------------------------------------------

```{r}
gene <- reactiveValues(gene = "SLC2A4")

observeEvent(input$gene, {
  ga_collect_event(event_category = "Gene input", event_action = "typed gene")
  gene$gene <- input$gene
})

observeEvent(c(input$skeletalBrush,
               input$betaBrush,
               input$adiposeBrush),{
                 temp <- c(
                   brushedPoints(dat[Tissue == "adipose" & abs(logFC)>.32,], 
                                 input$adiposeBrush, "Rank", "logFC")$Symbol,
                   brushedPoints(dat[Tissue == "beta" & abs(logFC)>.32,], 
                                 input$betaBrush, "Rank", "logFC")$Symbol,
                   brushedPoints(dat[Tissue == "skeletal" & abs(logFC)>.32,], 
                                 input$skeletalBrush, "Rank", "logFC")$Symbol)
                 gene$gene <- temp
               })

observeEvent(gene$gene, {
  print(gene$gene)
  if(length(gene$gene)>10){
    ga_collect_event(event_category = "Gene input", event_action = "Brushed too many genes")
    temp <- ggplot(data.frame(x = 1, y = 1, label = "Too many genes to visualize"), 
                   aes(x,y,label = label)) + geom_text() + theme_void()
    output$genes <- renderPlot(temp)
  }else{
    if(length(gene$gene)==0){
      temp <- ggplot(data.frame(x = 1, y = 1, label = "Select interesting genes from from the plots"), 
                   aes(x,y,label = label)) + geom_text() + theme_void()
      output$genes <- renderPlot(temp)
    }else{
      ga_collect_event(event_category = "Gene input", event_action = "Brushed less than 10 genes")
      output$genes <- renderPlot(tissueComp(as.character(gene$gene)))
    }
  }
})
```

### Comparing genes across tissues

```{r}
plotOutput("genes")
```

### Table

```{r}
renderDataTable(dat[Symbol %in% gene$gene, c("Symbol", 
                                             "Tissue", 
                                             "logFC", 
                                             "adj.P.Val", 
                                             "Rank")][order(Symbol)],
                options = list(paginate = FALSE))
```

